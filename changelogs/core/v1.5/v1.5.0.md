# v1.5

This update is more focused on bug fixes and code maintenance.

## HTTP engine abstraction

The Sisk Framework is now independent of [HttpListener](https://learn.microsoft.com/en/dotnet/api/system.net.httplistener?view=net-9.0).

In this update, all HttpListener-dependent mechanisms have been abstracted into what are called HTTP Engines, which control the abstraction level between the framework and the incoming HTTP components.

With this change, Sisk will be able to use other HTTP processors, such as [Cadente Project](https://github.com/sisk-http/core/tree/main/cadente), [Kestrel](https://learn.microsoft.com/en-us/aspnet/core/fundamentals/servers/kestrel?view=aspnetcore-9.0), or other servers.

Each server can bring features not previously supported natively in Sisk, such as SSL, Quic, pipelining, etc.

Currently, Sisk continues to use .NET's HttpListener as it remains the most stable. Follow and contribute to the development of the Cadente engine for Sisk [here](https://github.com/sisk-http/core/tree/main/cadente/Sisk.Cadente.CoreEngine).

## CORS Improvements

In this update, two global constants have been introduced:

- `CrossOriginResourceSharingHeaders.AutoFromRequestMethod`
- `CrossOriginResourceSharingHeaders.AutoFromRequestHeaders`

The behavior is similar to `CrossOriginResourceSharingHeaders.AutoAllowOrigin`: the server responds with CORS headers according to the request:

```csharp
using var host = HttpServer.CreateBuilder()
    .UseCors(new CrossOriginResourceSharingHeaders(
        allowOrigin: CrossOriginResourceSharingHeaders.AutoAllowOrigin,
        allowMethods: [CrossOriginResourceSharingHeaders.AutoFromRequestMethod],
        allowHeaders: [CrossOriginResourceSharingHeaders.AutoFromRequestHeaders],
        exposeHeaders: [HttpKnownHeaderNames.ContentType, "X-Authenticated-Account-Id"],
        allowCredentials: true))
    ...
```

## Web socket API breaking changes

The entire API for the `HttpWebSocket` class was changed. The motivation for this change was to reduce async/await errors, since the internal WebSocket object doesn't provide a synchronous API. This API rewrite fixes memory leak issues, error handling in asynchronous events, and message pooling.

- No more synchronous methods or events.
- All `Send()` methods were removed. Use `SendAsync()` overloads instead.
- No more `WaitForExit()` methods. Use `ReceiveMessageAsync()` with a cancellation token or timeout instead.
- No more `Close()`. Use `CloseAsync()` instead.

Read the updated docs for more info.

## Bug fixes and other changes

- Entirely refactored the `LogStream` code:
    - General improvements and fixes in concurrent writing.
    - Improvements in asynchronous and synchronous processing.
    - Improvements in the shared `LogStream` singleton.
    - Fixes for `Flush` and `FlushAsync` discharge.
    - Fixed a bug that caused the circular buffer to come in reverse.
    - Implemented `IAsyncDisposable`.
- General fixes and improvements in `CircularBuffer<T>`.
- Added `HttpRequest.DisconnectToken`. Note: this feature may not be compatible with all HTTP engines.
- Added the `LogMode` property for the `HttpContext` class. With this property, you can decide which log modes are enabled for the current context, which will override the current route log mode.
- Added the `HttpContext.GetCurrentContext()` method, which returns the current `HttpContext` if the current thread is running on a HTTP request context.
- Added the `HttpResponse.GetHeaderValue()` helper method, which attempts to get an header value from both defined `HttpResponse.Content.Headers` property or `HttpResponse.Headers`.
- Added the `HttpServerConfiguration.DefaultAccessLogFormat` constant.
- Added the `TypedValueDictionary.GetValue` and `TypedValueDictionary.SetValue` helper methods.
- Added the `MimeHelper.IsPlainTextMimeType` helper method.
- Added the `{:header}` constant literal for the log-formatting options.
- Improved exception-handling for forwarding resolvers.
- Fixed an issue where the `ForwardingResolver` methods could throw an exception before the initialization of the `HttpRequest` object, which caused the `HttpServerExecutionResult.HttpRequest` to have an null `HttpRequest` object.
- Fixed an possible stack overflow issue when using `InitializationParameterCollection.ContainsKey`.
- Fixed an issue where the HTTP server were compressing already compressed contents through the `EnableAutomaticResponseCompression` option.
- Fixed an issue where the HTTP server were trying to send responses generated by the `Router.CallbackErrorHandler`, `Router.NotFoundErrorHandler`, `Router.MethodNotAllowedErrorHandler` to contexts where was streaming content.
- Fixed issues where some HTTP headers could be set after sending content on the `HttpResponseStreamManager` class.
- Fixed issues in the access log formatter.
- Fixed an issue where the HTTP server was not enabling error-logging for user-handled errors.